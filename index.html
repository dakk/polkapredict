<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PolkaPredict — Polkadot Validator Analytics</title>
<style>
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --accent: #e91e8c;
    --accent2: #ff6bc1;
    --text: #eaeaea;
    --text-muted: #8892a4;
    --green: #4ade80;
    --amber: #fbbf24;
    --red: #f87171;
    --border: #2a2a4a;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }
  .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

  /* Header */
  header {
    text-align: center;
    padding: 30px 0 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }
  header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .updated {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-top: 6px;
  }

  /* Search */
  .search-wrap {
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
  }
  .search-wrap input {
    width: 100%;
    max-width: 500px;
    padding: 10px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    font-size: 0.95rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-wrap input:focus { border-color: var(--accent); }
  .search-wrap input::placeholder { color: var(--text-muted); }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--border);
  }
  .tab {
    padding: 10px 24px;
    cursor: pointer;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 0.95rem;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
  }
  .tab:hover { color: var(--text); }
  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Stats cards */
  .stats {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 24px;
    flex: 1;
    min-width: 180px;
  }
  .stat-card .label {
    font-size: 0.8rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .stat-card .value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-top: 4px;
  }
  .stat-card .value.pink { color: var(--accent); }
  .stat-card .value.green { color: var(--green); }
  .stat-card .value.amber { color: var(--amber); }
  .stat-card .value.red { color: var(--red); }

  /* Table */
  .table-wrap {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--surface);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
  }
  th {
    background: var(--surface2);
    padding: 12px 14px;
    text-align: left;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    position: sticky;
    top: 0;
  }
  th:hover { color: var(--text); }
  th .sort-arrow { margin-left: 4px; font-size: 0.7rem; }
  td {
    padding: 10px 14px;
    border-top: 1px solid var(--border);
    white-space: nowrap;
  }
  tr:hover td { background: rgba(233, 30, 140, 0.04); }
  .num { text-align: right; font-variant-numeric: tabular-nums; }

  /* Badges */
  .badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .badge-active { background: rgba(74, 222, 128, 0.15); color: var(--green); }
  .badge-waiting { background: rgba(251, 191, 36, 0.15); color: var(--amber); }
  .badge-zero { background: rgba(248, 113, 113, 0.15); color: var(--red); }

  /* Address */
  .addr {
    font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
    font-size: 0.82rem;
    color: var(--text-muted);
  }
  .addr-full { display: none; }
  .copy-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.8rem;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.2s;
  }
  .copy-btn:hover { color: var(--accent); background: rgba(233, 30, 140, 0.1); }

  /* Pagination */
  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 16px;
    padding: 12px;
  }
  .pagination button {
    padding: 6px 14px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
  }
  .pagination button:hover:not(:disabled) {
    border-color: var(--accent);
    color: var(--accent);
  }
  .pagination button:disabled {
    opacity: 0.4;
    cursor: default;
  }
  .pagination .page-info {
    color: var(--text-muted);
    font-size: 0.85rem;
    min-width: 120px;
    text-align: center;
  }

  /* Error */
  .error-box {
    background: var(--surface);
    border: 1px solid var(--red);
    border-radius: 10px;
    padding: 24px;
    text-align: center;
    color: var(--text-muted);
    margin: 40px 0;
  }
  .error-box h3 { color: var(--red); margin-bottom: 10px; }
  .error-box code {
    background: var(--bg);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
  }

  /* Sub-section headers */
  .section-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 24px 0 12px;
    color: var(--text);
  }

  @media (max-width: 768px) {
    .container { padding: 12px; }
    header h1 { font-size: 1.3rem; }
    .stats { gap: 8px; }
    .stat-card { padding: 12px 16px; min-width: 140px; }
    .stat-card .value { font-size: 1.2rem; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>PolkaPredict</h1>
    <p style="color: var(--text-muted); font-size: 0.95rem; margin-top: 2px;">Polkadot Validator Analytics</p>
    <p class="updated" id="updated-election"></p>
    <p class="updated" id="updated-selfstake"></p>
  </header>

  <div class="search-wrap">
    <input type="text" id="search" placeholder="Search by validator name or address...">
  </div>

  <div class="tabs">
    <button class="tab" data-tab="election">Waiting Validators Ranking</button>
    <button class="tab active" data-tab="selfstake">Self-Stake Analysis</button>
  </div>

  <!-- Election Ranking Tab -->
  <div class="tab-content" id="tab-election">
    <div id="election-error"></div>
    <div class="stats" id="election-stats"></div>
    <div class="table-wrap">
      <table id="election-table">
        <thead>
          <tr>
            <th data-sort="rank" data-type="num">Rank <span class="sort-arrow"></span></th>
            <th data-sort="name" data-type="str">Name <span class="sort-arrow"></span></th>
            <th data-sort="self_stake_dot" data-type="num" class="num">Self-Stake (DOT) <span class="sort-arrow"></span></th>
            <th data-sort="nominator_backing_dot" data-type="num" class="num">Nom. Backing (DOT) <span class="sort-arrow"></span></th>
            <th data-sort="estimated_total_dot" data-type="num" class="num">Total Backing (DOT) <span class="sort-arrow"></span></th>
            <th>Address</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="pagination" id="election-pagination"></div>
  </div>

  <!-- Self-Stake Analysis Tab -->
  <div class="tab-content active" id="tab-selfstake">
    <div id="selfstake-error"></div>
    <div class="stats" id="selfstake-stats"></div>

    <div class="section-title">Zero Self-Stake Validators</div>
    <div class="table-wrap">
      <table id="zero-table">
        <thead>
          <tr>
            <th data-sort="idx" data-type="num"># <span class="sort-arrow"></span></th>
            <th data-sort="name" data-type="str">Name <span class="sort-arrow"></span></th>
            <th>Address</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="pagination" id="zero-pagination"></div>

    <div class="section-title" style="margin-top: 32px;">Under 10k DOT Self-Stake (non-zero)</div>
    <div class="table-wrap">
      <table id="under10k-table">
        <thead>
          <tr>
            <th data-sort="idx" data-type="num"># <span class="sort-arrow"></span></th>
            <th data-sort="name" data-type="str">Name <span class="sort-arrow"></span></th>
            <th data-sort="self_stake_dot" data-type="num" class="num">Self-Stake (DOT) <span class="sort-arrow"></span></th>
            <th>Address</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="pagination" id="under10k-pagination"></div>
  </div>
</div>

<script>
const PAGE_SIZE = 50;
let electionData = null;
let selfstakeData = null;

// State per table
const tables = {
  election:  { rows: [], filtered: [], sortCol: 'rank', sortAsc: true, page: 0 },
  zero:      { rows: [], filtered: [], sortCol: 'idx', sortAsc: true, page: 0 },
  under10k:  { rows: [], filtered: [], sortCol: 'self_stake_dot', sortAsc: false, page: 0 },
};

// ── Helpers ────────────────────────────────────────────────────────

function fmt(n) {
  return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
}

function truncAddr(addr) {
  return addr.slice(0, 8) + '...' + addr.slice(-6);
}

function copyAddr(addr) {
  navigator.clipboard.writeText(addr);
}

function formatTimestamp(iso) {
  const d = new Date(iso);
  const now = new Date();
  const mins = Math.floor((now - d) / 60000);
  let ago;
  if (mins < 1) ago = 'just now';
  else if (mins < 60) ago = mins + 'm ago';
  else if (mins < 1440) ago = Math.floor(mins / 60) + 'h ago';
  else ago = Math.floor(mins / 1440) + 'd ago';
  const abs = d.toLocaleDateString('en-US', {
    month: 'short', day: 'numeric', year: 'numeric',
    hour: '2-digit', minute: '2-digit',
  });
  return `${abs} (${ago})`;
}

function showError(containerId, msg) {
  document.getElementById(containerId).innerHTML =
    `<div class="error-box"><h3>Data Not Available</h3><p>${msg}</p></div>`;
}

// ── Tabs ───────────────────────────────────────────────────────────

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// ── Search ─────────────────────────────────────────────────────────

document.getElementById('search').addEventListener('input', (e) => {
  const q = e.target.value.toLowerCase().trim();
  filterAll(q);
});

function filterAll(q) {
  for (const [key, state] of Object.entries(tables)) {
    state.filtered = q
      ? state.rows.filter(r => (r.name || '').toLowerCase().includes(q) || (r.address || '').toLowerCase().includes(q))
      : [...state.rows];
    state.page = 0;
    renderTable(key);
  }
}

// ── Sorting ────────────────────────────────────────────────────────

document.querySelectorAll('th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const tableEl = th.closest('table');
    const key = tableEl.id.replace('-table', '');
    const col = th.dataset.sort;
    const state = tables[key];
    if (state.sortCol === col) {
      state.sortAsc = !state.sortAsc;
    } else {
      state.sortCol = col;
      state.sortAsc = th.dataset.type === 'num';
    }
    sortAndRender(key);
  });
});

function sortAndRender(key) {
  const state = tables[key];
  const col = state.sortCol;
  const asc = state.sortAsc;
  state.filtered.sort((a, b) => {
    let va = a[col], vb = b[col];
    if (typeof va === 'string') va = va.toLowerCase();
    if (typeof vb === 'string') vb = vb.toLowerCase();
    if (va < vb) return asc ? -1 : 1;
    if (va > vb) return asc ? 1 : -1;
    return 0;
  });
  state.page = 0;
  renderTable(key);
}

// ── Rendering ──────────────────────────────────────────────────────

function renderTable(key) {
  const state = tables[key];
  const tbody = document.querySelector(`#${key}-table tbody`);
  const start = state.page * PAGE_SIZE;
  const pageRows = state.filtered.slice(start, start + PAGE_SIZE);
  const totalPages = Math.ceil(state.filtered.length / PAGE_SIZE) || 1;

  tbody.innerHTML = pageRows.map(r => {
    if (key === 'election') return electionRow(r);
    if (key === 'zero') return zeroRow(r);
    return under10kRow(r);
  }).join('');

  // Update sort arrows
  document.querySelectorAll(`#${key}-table th[data-sort]`).forEach(th => {
    const arrow = th.querySelector('.sort-arrow');
    if (th.dataset.sort === state.sortCol) {
      arrow.textContent = state.sortAsc ? ' \u25B2' : ' \u25BC';
    } else {
      arrow.textContent = '';
    }
  });

  // Pagination
  const pagDiv = document.getElementById(`${key}-pagination`);
  pagDiv.innerHTML = `
    <button onclick="changePage('${key}', -1)" ${state.page === 0 ? 'disabled' : ''}>Prev</button>
    <span class="page-info">Page ${state.page + 1} of ${totalPages} (${state.filtered.length} rows)</span>
    <button onclick="changePage('${key}', 1)" ${state.page + 1 >= totalPages ? 'disabled' : ''}>Next</button>
  `;
}

function changePage(key, delta) {
  const state = tables[key];
  const totalPages = Math.ceil(state.filtered.length / PAGE_SIZE);
  state.page = Math.max(0, Math.min(totalPages - 1, state.page + delta));
  renderTable(key);
}

function electionRow(r) {
  return `<tr>
    <td class="num">${r.rank}</td>
    <td>${esc(r.name)}</td>
    <td class="num">${fmt(r.self_stake_dot)}</td>
    <td class="num">${fmt(r.nominator_backing_dot)}</td>
    <td class="num">${fmt(r.estimated_total_dot)}</td>
    <td><span class="addr" title="${r.address}">${truncAddr(r.address)}</span>
        <button class="copy-btn" onclick="copyAddr('${r.address}')">Copy</button></td>
  </tr>`;
}

function zeroRow(r) {
  return `<tr>
    <td class="num">${r.idx}</td>
    <td>${esc(r.name)}</td>
    <td><span class="addr" title="${r.address}">${truncAddr(r.address)}</span>
        <button class="copy-btn" onclick="copyAddr('${r.address}')">Copy</button></td>
  </tr>`;
}

function under10kRow(r) {
  return `<tr>
    <td class="num">${r.idx}</td>
    <td>${esc(r.name)}</td>
    <td class="num">${r.self_stake_dot.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
    <td><span class="addr" title="${r.address}">${truncAddr(r.address)}</span>
        <button class="copy-btn" onclick="copyAddr('${r.address}')">Copy</button></td>
  </tr>`;
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ── Data Loading ───────────────────────────────────────────────────

async function loadData() {
  // Election data
  try {
    const resp = await fetch('data/election.json', { cache: 'no-store' });
    if (!resp.ok) throw new Error(resp.status);
    electionData = await resp.json();

    document.getElementById('updated-election').textContent =
      'Election data: ' + formatTimestamp(electionData.generated_at);

    document.getElementById('election-stats').innerHTML = `
      <div class="stat-card"><div class="label">Total Validators</div>
        <div class="value pink">${fmt(electionData.active_validators + electionData.waiting_validators)}</div></div>
      <div class="stat-card"><div class="label">Active</div>
        <div class="value green">${fmt(electionData.active_validators)}</div></div>
      <div class="stat-card"><div class="label">Waiting</div>
        <div class="value amber">${fmt(electionData.waiting_validators)}</div></div>
      <div class="stat-card"><div class="label">Data Source</div>
        <div class="value" style="font-size:1.1rem">${electionData.mode.toUpperCase()}</div></div>
    `;

    const waitingOnly = electionData.validators.filter(v => !v.is_active);
    waitingOnly.forEach((v, i) => v.rank = i + 1);
    tables.election.rows = waitingOnly;
    tables.election.filtered = [...tables.election.rows];
    renderTable('election');
  } catch (e) {
    showError('election-error',
      'Could not load <code>data/election.json</code>. Run:<br><br>' +
      '<code>python polkadot_election_prediction.py</code>');
  }

  // Self-stake data
  try {
    const resp = await fetch('data/selfstake.json', { cache: 'no-store' });
    if (!resp.ok) throw new Error(resp.status);
    selfstakeData = await resp.json();

    document.getElementById('updated-selfstake').textContent =
      'Self-stake data: ' + formatTimestamp(selfstakeData.generated_at);

    const total = selfstakeData.total_active_validators;
    const zeroPct = (selfstakeData.zero_selfstake_count / total * 100).toFixed(1);
    const u10kPct = (selfstakeData.under_10k_count / total * 100).toFixed(1);

    document.getElementById('selfstake-stats').innerHTML = `
      <div class="stat-card"><div class="label">Active Validators</div>
        <div class="value green">${fmt(total)}</div></div>
      <div class="stat-card"><div class="label">Zero Self-Stake</div>
        <div class="value red">${selfstakeData.zero_selfstake_count} (${zeroPct}%)</div></div>
      <div class="stat-card"><div class="label">Under 10k DOT</div>
        <div class="value amber">${selfstakeData.under_10k_count} (${u10kPct}%)</div></div>
    `;

    tables.zero.rows = selfstakeData.zero_selfstake.map((v, i) => ({
      idx: i + 1, name: v.name, address: v.address,
    }));
    tables.zero.filtered = [...tables.zero.rows];
    renderTable('zero');

    const nonZeroUnder10k = selfstakeData.under_10k.filter(v => v.self_stake_dot > 0);
    tables.under10k.rows = nonZeroUnder10k.map((v, i) => ({
      idx: i + 1, name: v.name, address: v.address, self_stake_dot: v.self_stake_dot,
    }));
    tables.under10k.filtered = [...tables.under10k.rows];
    renderTable('under10k');
  } catch (e) {
    showError('selfstake-error',
      'Could not load <code>data/selfstake.json</code>. Run:<br><br>' +
      '<code>python polkadot_zero_selfstake.py</code>');
  }
}

loadData();
</script>
</body>
</html>
